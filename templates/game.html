{% extends "base.html" %}

{% block meta %} 
<meta name="description" content="Play a fun game of trivia with your friends!"/>
<meta property="og:image" content="{{ url_for('static', filename='art/cloud1.png') }}"/>
<meta property="og:description" content="Play a fun game of trivia with your friends!"/>
<meta property="og:title" content="Domain - Trivia With Friends"/>
<title>Domain - Trivia With Friends</title>
{% endblock %}

{% block styles %}
{{ super() }}
{% endblock %}

{% block preload_scripts %}
{% endblock %}

{% block content %}
<div id="content">
    <div>
        <p id="question">{{ questions[current_idx] }}</p>
        <div id="answers">
            {% for answer_choice in answers[current_idx] %}
                <button type="button">{{ answer_choice }}</button>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block postload_scripts %}
<script>
    function loadQuestion(question, answer_choices) {
        document.getElementById("question").innerText = decodeBase64(question)
        answerEls = document.getElementById("answers").children;
        for(let i=0;i<answerEls.length;i++) {
            answerEls[i].innerText = decodeBase64(answer_choices[i])
            answerEls[i].addEventListener("click", () => {
                checkAnswer(cleanString(answer_choices[i]))
            })
        }
    }
    async function checkAnswer(ans) {
        const response = await fetch("/check_ans", {
            method: "POST",
            headers: {
                    "Content-Type": "application/json"
                },
            body: JSON.stringify({ room_id: room_id, answer: ans })
        })
        const data = await response.json()
        if (data.correct) {
            console.log("correct answer");
            current_idx++;
            loadQuestion(questions[current_idx], all_answer_choices[current_idx])
        } else {
            console.log("incorrect answer");
        }
    }
    function cleanString(input) {
        // remove apostrophes around string first
        return input.substring(5, input.length-5);
    }
    function decodeBase64(encoded) {
        return atob(cleanString(encoded))
    }
</script>
<script>
    const room_id = "{{ room_id }}"

    let questions = "{{ questions }}"
    questions = questions.substring(1, questions.length-1).split(", ")

    let all_answer_choices = "{{ answers }}"
    all_answer_choices = all_answer_choices.substring(1, all_answer_choices.length-1).split("], ")
    for(let i=0; i<all_answer_choices.length;i++) {
        all_answer_choices[i] = all_answer_choices[i].substring(1, all_answer_choices[i].length).split(", ")
    }

    let current_idx = Number("{{ current_idx }}")

    document.getElementById("question").innerText = `${decodeBase64(questions[current_idx])}`
    answerEls = document.getElementById("answers").children;
    for(let i=0;i<answerEls.length;i++) {
        answerEls[i].innerText = decodeBase64(all_answer_choices[current_idx][i])
        answerEls[i].addEventListener("click", () => {
            checkAnswer(cleanString(all_answer_choices[current_idx][i]))
        })
    }
</script>
{% endblock %}