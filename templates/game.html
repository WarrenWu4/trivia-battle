{% extends "base.html" %}

{% block meta %} 
<meta name="description" content="Play a fun game of trivia with your friends!"/>
<meta property="og:image" content="{{ url_for('static', filename='art/cloud1.png') }}"/>
<meta property="og:description" content="Play a fun game of trivia with your friends!"/>
<meta property="og:title" content="Domain - Trivia With Friends"/>
<title>Domain - Trivia With Friends</title>
{% endblock %}

{% block styles %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/game.css') }}">
{{ super() }}
{% endblock %}

{% block preload_scripts %}
{% endblock %}

{% block nav %}
<nav>
    <h1>USERNAME</h1>
    <div>
        <a href="/">
            <img src="{{ url_for('static', filename='icons/Times.svg') }}" alt="close"/>
        </a>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="content">
    <div class="neobrutalist toolbar">
        <p>60 sec</p>
        <p>+2000 pts</p>
    </div>
    <div class="neobrutalist qa">
        <p id="question"></p>
        <div id="answers"></div>
    </div>
</div>
{% endblock %}

{% block postload_scripts %}
<script>
    const game_id = "{{ game_id }}"

    init();

    async function init() {
        const response = await fetch(`/game/${game_id}/get_question`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const data = await response.json();
        question = data.question
        answer_choices = data.answers
        curr_question = data.curr_question

        const questionEl = document.getElementById("question");
        const answersEl = document.getElementById("answers");
        questionEl.textContent = decodeBase64(question);
        for (let i = answersEl.children.length - 1; i >= 0; i--) {
            answersEl.removeChild(answersEl.children[i]);
        }
        for(let i=0; i<answer_choices.length; i++) {
            const btn = document.createElement("button")
            const img = document.createElement("img")
            img.src = "{{ url_for('static', filename='icons/Play.svg') }}"
            btn.appendChild(img);

            const text = document.createElement("p")
            text.textContent = decodeBase64(answer_choices[i])
            btn.appendChild(text);
            btn.addEventListener("click", async function() {
                checkAns(answer_choices[i]);
                getNextQuestion();
            });

            answersEl.appendChild(btn)
        }
    }

    function decodeBase64(encoded) {
        return atob(encoded)
    }

    async function checkAns(answer_choice) {
        const response = await fetch(`/game/${game_id}/check`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                answer: answer_choice
            })
        });
        const data = await response.json();
        return data.correct;
    }

    async function getNextQuestion() {
        const response = await fetch(`/game/${game_id}/next`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const data = await response.json();
        if (data.ok && !data.game_over) {
            init();
        } else if (data.ok && data.game_over) {
            window.location.href = `/game/${game_id}/results`;
        } else {
            console.log("uh oh...");
        }
    }
</script>
{% endblock %}